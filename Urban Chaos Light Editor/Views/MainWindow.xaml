<Window x:Class="UrbanChaosLightEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:UrbanChaosLightEditor.Views"
        Title="{Binding WindowTitle}" 
        Width="1400" Height="900"
        WindowStartupLocation="CenterScreen"
        Background="#1E1E1E">

    <Window.InputBindings>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenLightsCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl+Shift" Command="{Binding OpenMapCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewLightsCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveLightsCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveLightsAsCommand}"/>
        <KeyBinding Key="Delete" Command="{Binding DeleteLightCommand}"/>
        <KeyBinding Key="C" Modifiers="Ctrl" Command="{Binding CopyLightCommand}"/>
        <KeyBinding Key="V" Modifiers="Ctrl" Command="{Binding PasteLightCommand}"/>
    </Window.InputBindings>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <!-- Toggle button style for layer visibility -->
        <Style x:Key="LayerToggleStyle" TargetType="ToggleButton">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="MinWidth" Value="70"/>
            <Setter Property="Background" Value="#3C3C3C"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="3"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#0078D4"/>
                                <Setter TargetName="border" Property="BorderBrush" Value="#1E90FF"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="#888"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Toolbar button style -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Background" Value="#3C3C3C"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="3"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#4C4C4C"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#0078D4"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top" Background="{StaticResource BackgroundLight}" Foreground="{StaticResource TextPrimary}>
            <MenuItem Header="_File">
                <MenuItem Header="_New Lights File" Command="{Binding NewLightsCommand}" InputGestureText="Ctrl+N"/>
                <Separator/>
                <MenuItem Header="_Open Lights File..." Command="{Binding OpenLightsCommand}" InputGestureText="Ctrl+O"/>
                <MenuItem Header="Open _Map..." Command="{Binding OpenMapCommand}" InputGestureText="Ctrl+Shift+O" ToolTip="Open a map for display (textures/buildings)"/>
                <Separator/>
                <MenuItem Header="_Save Lights" Command="{Binding SaveLightsCommand}" InputGestureText="Ctrl+S" 
                          IsEnabled="{Binding IsLightsLoaded}"/>
                <MenuItem Header="Save Lights _As..." Command="{Binding SaveLightsAsCommand}" InputGestureText="Ctrl+Shift+S"
                          IsEnabled="{Binding IsLightsLoaded}"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Copy Light" Command="{Binding CopyLightCommand}" InputGestureText="Ctrl+C"
                          IsEnabled="{Binding HasSelectedLight}"/>
                <MenuItem Header="_Paste Light" Command="{Binding PasteLightCommand}" InputGestureText="Ctrl+V"
                          IsEnabled="{Binding CanPasteLight}"/>
                <MenuItem Header="_Delete Light" Command="{Binding DeleteLightCommand}" InputGestureText="Delete"
                          IsEnabled="{Binding HasSelectedLight}"/>
                <Separator/>
                <MenuItem Header="Select _All Lights" Command="{Binding SelectAllLightsCommand}"/>
                <MenuItem Header="Deselect All" Command="{Binding DeselectAllCommand}"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="Show _Textures" IsCheckable="True" IsChecked="{Binding ShowTextures}"/>
                <MenuItem Header="Show _Grid Lines" IsCheckable="True" IsChecked="{Binding ShowGridLines}"/>
                <MenuItem Header="Show _Buildings" IsCheckable="True" IsChecked="{Binding ShowBuildings}"/>
                <MenuItem Header="Show _Objects" IsCheckable="True" IsChecked="{Binding ShowPrimGraphics}"/>
                <Separator/>
                <MenuItem Header="Show _Lights" IsCheckable="True" IsChecked="{Binding ShowLights}"/>
                <MenuItem Header="Show Light _Ranges" IsCheckable="True" IsChecked="{Binding ShowLightRanges}"/>
                <Separator/>
                <MenuItem Header="Zoom _In" Command="{Binding ZoomInCommand}" InputGestureText="Ctrl++"/>
                <MenuItem Header="Zoom _Out" Command="{Binding ZoomOutCommand}" InputGestureText="Ctrl+-"/>
                <MenuItem Header="_Reset Zoom" Command="{Binding ResetZoomCommand}" InputGestureText="Ctrl+0"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Background="#2D2D2D" Padding="4">
            <WrapPanel>
                <!-- File operations -->
                <Button Style="{StaticResource ToolbarButtonStyle}" Content="🗺️ Map" 
                        Command="{Binding OpenMapCommand}" ToolTip="Open Map (Ctrl+Shift+O)"/>
                <Button Style="{StaticResource ToolbarButtonStyle}" Content="💡 Lights" 
                        Command="{Binding OpenLightsCommand}" ToolTip="Open Lights (Ctrl+O)"/>
                <Button Style="{StaticResource ToolbarButtonStyle}" Content="💾 Save" 
                        Command="{Binding SaveLightsCommand}" ToolTip="Save Lights (Ctrl+S)"
                        IsEnabled="{Binding IsLightsLoaded}"/>

                <Separator Margin="8,0" Background="#555"/>

                <!-- Layer visibility toggles (enabled when map is loaded) -->
                <TextBlock Text="Layers:" Foreground="#AAA" VerticalAlignment="Center" Margin="4,0"/>
                <ToggleButton Style="{StaticResource LayerToggleStyle}" Content="Textures" 
                              IsChecked="{Binding ShowTextures}" IsEnabled="{Binding IsMapViewLoaded}"/>
                <ToggleButton Style="{StaticResource LayerToggleStyle}" Content="Buildings" 
                              IsChecked="{Binding ShowBuildings}" IsEnabled="{Binding IsMapViewLoaded}"/>
                <ToggleButton Style="{StaticResource LayerToggleStyle}" Content="Objects" 
                              IsChecked="{Binding ShowPrimGraphics}" IsEnabled="{Binding IsMapViewLoaded}"/>
                <ToggleButton Style="{StaticResource LayerToggleStyle}" Content="Lights" 
                              IsChecked="{Binding ShowLights}" IsEnabled="{Binding IsLightsLoaded}"/>

                <Separator Margin="8,0" Background="#555"/>

                <!-- Light range toggle -->
                <ToggleButton Style="{StaticResource LayerToggleStyle}" Content="🔆 Ranges" 
                              IsChecked="{Binding ShowLightRanges}" IsEnabled="{Binding IsLightsLoaded}"
                              ToolTip="Show/hide light range circles"/>
            </WrapPanel>
        </Border>

        <!-- Status Bar -->
        <StatusBar DockPanel.Dock="Bottom" Background="#007ACC" Foreground="White">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <Separator Background="#555"/>
            <StatusBarItem>
                <TextBlock Text="{Binding LoadedMapFileName, StringFormat='Map: {0}'}"/>
            </StatusBarItem>
            <Separator Background="#555"/>
            <StatusBarItem>
                <TextBlock Text="{Binding LightsFileName, StringFormat='Lights: {0}'}"/>
            </StatusBarItem>
            <Separator Background="#555"/>
            <StatusBarItem>
                <TextBlock Text="{Binding LightCount, StringFormat='Count: {0}'}"/>
            </StatusBarItem>
            <Separator Background="#555"/>
            <StatusBarItem>
                <TextBlock Text="{Binding CursorPosition}"/>
            </StatusBarItem>
        </StatusBar>

        <!-- Main Content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="400"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="320" MinWidth="280"/>
            </Grid.ColumnDefinitions>

            <!-- Map View (left) -->
            <Border Grid.Column="0" BorderBrush="#444" BorderThickness="1" Background="#1A1A1A">
                <Grid>
                    <!-- Loading overlay -->
                    <Border Background="#80000000" 
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                            Panel.ZIndex="100">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="Loading..." Foreground="White" FontSize="18" 
                                       HorizontalAlignment="Center"/>
                            <ProgressBar IsIndeterminate="True" Width="200" Height="20" Margin="0,10,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Map view - ALWAYS visible, layers handle their own content -->
                    <local:LightEditorMapView x:Name="MapView"/>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" 
                          Background="#333" Cursor="SizeWE"/>

            <!-- Right Panel with Tabs -->
            <Border Grid.Column="2" BorderBrush="#444" BorderThickness="1" Background="#252526">
                <TabControl Background="#252526" BorderThickness="0">
                    <TabControl.Resources>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="#3C3C3C"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="Padding" Value="12,6"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Border x:Name="Border" Background="{TemplateBinding Background}" 
                                    BorderBrush="#555" BorderThickness="1,1,1,0" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#252526"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#4C4C4C"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.Resources>

                    <TabItem Header="Lights List">
                        <local:LightsPanel DataContext="{Binding}"/>
                    </TabItem>

                    <TabItem Header="Map Properties">
                        <local:LightPropertiesPanel/>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>
    </DockPanel>
</Window>