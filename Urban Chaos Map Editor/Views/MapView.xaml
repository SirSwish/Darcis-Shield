<UserControl x:Class="UrbanChaosMapEditor.Views.MapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ovl="clr-namespace:UrbanChaosMapEditor.Views.MapOverlays"
             Focusable="True"
             PreviewKeyDown="OnPreviewKeyDown">
    <Grid>
        <ScrollViewer x:Name="Scroller"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      CanContentScroll="False">
            <Grid RenderOptions.BitmapScalingMode="NearestNeighbor">
                <Grid.LayoutTransform>
                    <ScaleTransform ScaleX="{Binding Zoom}" ScaleY="{Binding Zoom}"/>
                </Grid.LayoutTransform>

                <Grid x:Name="Surface"
                      Width="8192" Height="8192"
                      Background="Transparent">

                    <!-- Existing layers -->
                    <ovl:TexturesLayer
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowTextures, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="0"
                        IsHitTestVisible="False"/>

                    <ovl:GridLinesLayer
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowGridLines, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="1"
                        IsHitTestVisible="False"/>

                    <ovl:MapWhoLayer
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowMapWho, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="2"
                        IsHitTestVisible="False"/>

                    <ovl:HeightsLayer
                        x:Name="HeightsOverlay"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowHeights, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="3"
                        IsHitTestVisible="False"/>

                    <ovl:BuildingLayer
                        x:Name="BuildingLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowBuildings, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="4"
                        IsHitTestVisible="False"/>

                    <ovl:PrimGraphicsLayer
                        x:Name="PrimGraphicsOverlay"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowPrimGraphics, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="5"
                        IsHitTestVisible="False"/>

                    <ovl:PrimsLayer
                        x:Name="PrimsOverlay"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowObjects, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="6"
                        IsHitTestVisible="True"/>
                    
                    <!-- NEW: Walkables overlay -->
                    <ovl:WalkablesLayer
                        x:Name="WalkablesOverlay"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowWalkables, Converter={StaticResource BoolToVis}}"
                        Panel.ZIndex="6"
                        IsHitTestVisible="False"/>
                    <!-- Add to MapView.xaml, where other overlays are -->
                    <ovl:AltitudeHoverLayer x:Name="AltitudeHoverLayer" 
                             DataContext="{Binding}"
                             Panel.ZIndex="50"/>


                    <!-- Ghost preview for texture painting -->
                    <ovl:GhostTexturePreviewLayer
                        x:Name="GhostLayer"
                        Width="8192" Height="8192"
                        Panel.ZIndex="99"
                        IsHitTestVisible="False"/>

                    <ovl:FacetRedrawPreviewLayer
                        x:Name="FacetRedrawLayer"
                        Width="8192" Height="8192"
                        Panel.ZIndex="100"
                        DataContext="{Binding}"
                        IsHitTestVisible="False"/>
                </Grid>
            </Grid>
        </ScrollViewer>
        <!-- Coordinate overlay (bottom-left) - matches Mission Editor -->
        <Border Background="#80000000" 
        HorizontalAlignment="Left" 
        VerticalAlignment="Bottom"
        Padding="8,4"
        Margin="10">
            <TextBlock x:Name="CoordinateText" 
               Foreground="White" 
               FontFamily="Consolas"
               FontSize="11">
        <Run Text="X: "/>
        <Run Text="{Binding CursorX}"/>
        <Run Text=" ("/>
        <Run Text="{Binding CursorTileX}"/>
        <Run Text=")  Z: "/>
        <Run Text="{Binding CursorZ}"/>
        <Run Text=" ("/>
        <Run Text="{Binding CursorTileZ}"/>
        <Run Text=")"/>
            </TextBlock>
        </Border>

        <!-- Zoom controls (bottom-right) - matches Mission Editor -->
        <StackPanel Orientation="Horizontal"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="10">
            <Button Content="-" Width="30" Height="30" 
            Command="{Binding ZoomOutCommand}"
            Background="#3D3D3D" Foreground="White" BorderBrush="#555555"
            ToolTip="Zoom Out"/>
            <Border Background="#3D3D3D" Padding="8,0" VerticalAlignment="Center">
                <TextBlock Foreground="White" VerticalAlignment="Center">
            <Run Text="{Binding Zoom, StringFormat=P0, Mode=OneWay}"/>
                </TextBlock>
            </Border>
            <Button Content="+" Width="30" Height="30" 
            Command="{Binding ZoomInCommand}"
            Background="#3D3D3D" Foreground="White" BorderBrush="#555555"
            ToolTip="Zoom In"/>
            <Button Content="Reset" Width="50" Height="30" Margin="5,0,0,0"
            Command="{Binding ResetZoomCommand}"
            Background="#3D3D3D" Foreground="White" BorderBrush="#555555"
            ToolTip="Reset Zoom (Ctrl+0)"/>
        </StackPanel>
    </Grid>
</UserControl>
