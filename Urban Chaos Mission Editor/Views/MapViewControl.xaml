<UserControl x:Class="UrbanChaosMissionEditor.Views.MapViewControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:UrbanChaosMissionEditor.Views"
             xmlns:ovl="clr-namespace:UrbanChaosMissionEditor.Views.MapOverlays"
             xmlns:conv="clr-namespace:UrbanChaosMissionEditor.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="600"
             Background="#1A1A1A"
             ClipToBounds="True"
             Focusable="True">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <Grid>
        <!-- Zoom/Pan container -->
        <ScrollViewer x:Name="ScrollContainer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      PanningMode="Both">

            <!-- Zoomable content -->
            <Grid x:Name="ZoomContainer" RenderOptions.BitmapScalingMode="NearestNeighbor">
                <Grid.LayoutTransform>
                    <ScaleTransform ScaleX="{Binding MapZoom}" ScaleY="{Binding MapZoom}"/>
                </Grid.LayoutTransform>

                <!-- Map surface (8192x8192 representing 128x128 tiles) -->
                <Grid x:Name="Surface" Width="8192" Height="8192" Background="#1A1A1A"
                      MouseLeftButtonDown="Surface_MouseLeftButtonDown"
                      MouseLeftButtonUp="Surface_MouseLeftButtonUp"
                      MouseMove="Surface_MouseMove"
                      MouseLeave="Surface_MouseLeave"
                      MouseWheel="Surface_MouseWheel">

                    <!-- Layer stack (from bottom to top) -->

                    <!-- 1. Textures Layer -->
                    <ovl:TexturesLayer x:Name="TexturesLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowTextures, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        Panel.ZIndex="0"
                        IsHitTestVisible="False"/>

                    <!-- 2. Grid Lines Layer -->
                    <ovl:GridLinesLayer x:Name="GridLinesLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowGridLines, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}"
                        Panel.ZIndex="1"
                        IsHitTestVisible="False"/>

                    <!-- 3. Buildings Layer -->
                    <ovl:BuildingLayer x:Name="BuildingLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowBuildings, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        Panel.ZIndex="2"
                        IsHitTestVisible="False"/>

                    <!-- 4. Prim Graphics Layer -->
                    <ovl:PrimGraphicsLayer x:Name="PrimGraphicsLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowPrimGraphics, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        Panel.ZIndex="3"
                        IsHitTestVisible="False"/>

                    <!-- 5. Light Layer -->
                    <ovl:LightLayer x:Name="LightLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowLights, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        ShowRanges="{Binding ShowLightRanges}"
                        Panel.ZIndex="4"
                        IsHitTestVisible="False"/>

              
                    <ovl:ZoneOverlay x:Name="ZoneLayer"
                        Width="8192" Height="8192"
                        Visibility="{Binding ShowZones, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        Panel.ZIndex="9"
                        IsHitTestVisible="False"/>

                    <!-- 6. EventPoints Layer -->
                    <ovl:EventPointsLayer x:Name="EventPointsLayer"
                        Width="8192" Height="8192"
                        EventPoints="{Binding EventPoints}"
                        SelectedEventPoint="{Binding SelectedEventPoint}"
                        Visibility="{Binding ShowEventPoints, Converter={StaticResource BoolToVis}, FallbackValue=Visible}"
                        IsHitTestVisible="False"/>

                </Grid>
            </Grid>
        </ScrollViewer>

        <!-- Coordinate overlay -->
        <Border Background="#80000000" 
                HorizontalAlignment="Left" 
                VerticalAlignment="Bottom"
                Padding="8,4"
                Margin="10">
            <TextBlock x:Name="CoordinateText" 
                       Foreground="White" 
                       FontFamily="Consolas"
                       FontSize="11"/>
        </Border>

        <!-- Zoom controls -->
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Bottom"
                    Margin="10">
            <Button Content="-" Width="30" Height="30" 
                    Command="{Binding ZoomOutCommand}"
                    Background="#3D3D3D" Foreground="White" BorderBrush="#555555"/>
            <Border Background="#3D3D3D" Padding="8,0" VerticalAlignment="Center">
                <TextBlock Foreground="White" VerticalAlignment="Center">
                    <Run Text="{Binding MapZoom, StringFormat=P0, Mode=OneWay}"/>
                </TextBlock>
            </Border>
            <Button Content="+" Width="30" Height="30" 
                    Command="{Binding ZoomInCommand}"
                    Background="#3D3D3D" Foreground="White" BorderBrush="#555555"/>
            <Button Content="Reset" Width="50" Height="30" Margin="5,0,0,0"
                    Command="{Binding ResetZoomCommand}"
                    Background="#3D3D3D" Foreground="White" BorderBrush="#555555"/>
        </StackPanel>
    </Grid>
</UserControl>
